<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... [HEAD SECTION REMAINS EXACTLY THE SAME] ... -->
</head>
<body>
    <!-- ... [BODY CONTENT REMAINS EXACTLY THE SAME UP TO THE SCRIPT] ... -->

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- STEP 1 ‚Äî Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <script>
        // ‚ö†Ô∏è FIX 1: Remove duplicate supabase declaration
        // Add shortUUID function at the beginning
        function shortUUID(uuid) {
            return uuid.split("-")[0];
        }
        
        // ‚ö†Ô∏è FIX 2: Define showCalendar BEFORE it's used in HTML
        let isCalendarVisible = false;
        
        function showCalendar() {
            generateCalendar();
            
            document.getElementById('calendarContainer').style.display = 'block';
            document.getElementById('calendarBackdrop').style.display = 'block';
            isCalendarVisible = true;
            
            document.body.style.overflow = 'hidden';
        }
        
        function hideCalendar() {
            document.getElementById('calendarContainer').style.display = 'none';
            document.getElementById('calendarBackdrop').style.display = 'none';
            isCalendarVisible = false;
            
            document.body.style.overflow = '';
        }
        
        // Calendar variables
        let selectedCheckin = null;
        let selectedCheckout = null;
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu
            const menuToggle = document.querySelector('.menu-toggle');
            const navLinks = document.querySelector('.nav-links');
            
            if (menuToggle) {
                menuToggle.addEventListener('click', function() {
                    navLinks.classList.toggle('active');
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    this.setAttribute('aria-expanded', !isExpanded);
                });
                
                // UPDATED: Close mobile menu when clicking any link
                document.querySelectorAll('.nav-links a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        // Only close if it's a hash link (internal navigation)
                        if (link.getAttribute('href').startsWith('#')) {
                            navLinks.classList.remove('active');
                            menuToggle.setAttribute('aria-expanded', 'false');
                        }
                    });
                });
            }
            
            // Set current year
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize calendar with NO auto-selection
            initCalendarDates();
            
            // Initialize testimonials
            initTestimonials();
            
            // Initialize star rating
            initStarRating();
            
            // Form submission
            const inquiryForm = document.getElementById('inquiryForm');
            if (inquiryForm) {
                inquiryForm.addEventListener('submit', handleFormSubmit);
            }
            
            // Load properties on page load
            loadFeaturedProperties();
            
            // Close calendar when clicking backdrop
            document.getElementById('calendarBackdrop').addEventListener('click', hideCalendar);
            
            // Close calendar when pressing Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && isCalendarVisible) {
                    hideCalendar();
                }
            });
            
            // PHASE 4 ‚Äî Header Search Toggle
            const searchToggle = document.getElementById('searchToggle');
            const headerSearch = document.getElementById('headerSearch');
            
            if (searchToggle && headerSearch) {
                searchToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (window.innerWidth <= 768) {
                        // On mobile, show the search container
                        const mobileSearchContainer = document.getElementById('mobileSearchContainer');
                        mobileSearchContainer.classList.toggle('show');
                        if (mobileSearchContainer.classList.contains('show')) {
                            headerSearch.focus();
                        }
                    } else {
                        // On desktop, toggle the search input
                        headerSearch.classList.toggle('show');
                        if (headerSearch.classList.contains('show')) {
                            headerSearch.focus();
                        }
                    }
                });
                
                // Close search when clicking outside (desktop)
                document.addEventListener('click', function(e) {
                    if (window.innerWidth > 768 && 
                        !headerSearch.contains(e.target) && 
                        !searchToggle.contains(e.target)) {
                        headerSearch.classList.remove('show');
                    }
                });
                
                // Handle search when pressing Enter in header search
                headerSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const searchTerm = this.value.trim();
                        if (searchTerm) {
                            // Use header search for keyword filtering
                            searchPropertiesWithKeyword(searchTerm);
                            // Close search on mobile
                            if (window.innerWidth <= 768) {
                                document.getElementById('mobileSearchContainer').classList.remove('show');
                            }
                            this.value = '';
                            this.classList.remove('show');
                        }
                    }
                });
            }
            
            // CHANGE 3: Initialize Hero Carousel
            initHeroCarousel();
            
            // NEW: Check for hash on initial page load
            checkAndScrollToHash();
            
            // UPDATED: Add smooth scrolling for all internal links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    
                    // Skip if it's a javascript link or external link
                    if (href === '#' || href.startsWith('javascript:')) {
                        return;
                    }
                    
                    // Don't prevent default for hash-only links
                    if (href !== '#') {
                        e.preventDefault();
                        
                        const targetId = href.substring(1);
                        const targetElement = document.getElementById(targetId);
                        
                        if (targetElement) {
                            window.scrollTo({
                                top: targetElement.offsetTop - 80,
                                behavior: 'smooth'
                            });
                            
                            // Update URL without page reload
                            history.pushState(null, null, href);
                        }
                    }
                });
            });
        });
        
        // NEW: Function for service enquiries via WhatsApp
        function serviceEnquiry(serviceName) {
            const message = `Hello PwaniStays! I would like more information about your ${serviceName} services. Please provide details about availability, pricing, and what's included.`;
            const whatsappNumber = "254738544784";
            const encodedMessage = encodeURIComponent(message);
            
            window.open(
                `https://wa.me/${whatsappNumber}?text=${encodedMessage}`,
                "_blank"
            );
        }
        
        // CHANGE 3: Initialize Hero Carousel Function
        function initHeroCarousel() {
            const heroSwiper = new Swiper('.heroSwiper', {
                spaceBetween: 0,
                slidesPerView: 1,
                loop: true,
                autoplay: {
                    delay: 7000,
                    disableOnInteraction: false,
                },
                speed: 1000,
                effect: 'fade',
                fadeEffect: {
                    crossFade: true
                },
                // No navigation or pagination
                navigation: false,
                pagination: false
            });
            
            console.log('Hero carousel initialized with 2 images (no diver)');
        }
        
        // NEW: Function to check hash and scroll to property
        function checkAndScrollToHash() {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#property-')) {
                // Extract the short UUID from the hash
                const shortId = hash.replace('#property-', '');
                
                // Show search results section
                document.getElementById('searchResults').style.display = 'block';
                document.getElementById('stays').style.display = 'none';
                
                // Scroll to search results
                document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
                
                // Load all properties and then scroll to the specific one
                loadAllPropertiesAndScroll(shortId);
            }
        }
        
        // NEW: Modified loadAllProperties to accept scroll callback
        async function loadAllPropertiesAndScroll(targetShortId) {
            const container = document.getElementById('propertyList');
            container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading property...</div>';
            
            try {
                // ‚ö†Ô∏è FIX 3: Single Supabase client declaration
                const SUPABASE_URL = "https://aanyrtsfeeynykskwxen.supabase.co";
                const SUPABASE_KEY = "sb_publishable_jda30uQX9ZzR_V8CzkeERw_nfx-QWkD";
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                const { data, error } = await supabase
                    .from("properties")
                    .select("*")
                    .eq("is_active", true)
                    .order("created_at", { ascending: false });
                
                if (error) {
                    console.error("Error loading properties:", error);
                    container.innerHTML = '<div class="no-properties"><p>Unable to load properties. Please try again later.</p></div>';
                    return;
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-properties"><p>No properties available at the moment. Check back soon!</p></div>';
                    return;
                }
                
                // FIXED: Clear container by removing child elements
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                
                // Create document fragment for batch append
                const fragment = document.createDocumentFragment();
                const cards = [];
                
                // Create all cards
                data.forEach(property => {
                    const card = createPropertyCard(property);
                    cards.push({ property, card });
                    fragment.appendChild(card);
                });
                
                // Append all cards at once
                container.appendChild(fragment);
                
                // Load images for each property
                setTimeout(() => {
                    cards.forEach(({ property }) => {
                        loadPropertyImages(property);
                    });
                    
                    // AFTER properties are loaded, try to find and scroll to the target
                    setTimeout(() => {
                        scrollToProperty(targetShortId);
                    }, 500);
                    
                    // Debug after loading
                    setTimeout(debugSwipers, 1000);
                }, 300);
                
            } catch (error) {
                console.error("Error:", error);
                container.innerHTML = '<div class="no-properties"><p>Error loading properties. Please refresh the page.</p></div>';
            }
        }
        
        // NEW: Function to scroll to specific property
        function scrollToProperty(shortId) {
            // Try to find the element
            const targetElement = document.getElementById(`property-${shortId}`);
            
            if (targetElement) {
                // Scroll to the property
                targetElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center'
                });
                
                // Add highlight effect
                targetElement.style.boxShadow = '0 0 0 3px var(--primary), 0 10px 25px rgba(0, 0, 0, 0.2)';
                targetElement.style.transition = 'box-shadow 0.3s ease';
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    targetElement.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.15)';
                }, 3000);
                
                console.log(`Scrolled to property-${shortId}`);
            } else {
                console.log(`Could not find element with ID: property-${shortId}`);
                
                // Try alternative: look for any element with the short ID in its ID
                const alternativeElement = document.querySelector(`[id*="${shortId}"]`);
                if (alternativeElement) {
                    alternativeElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center'
                    });
                    console.log(`Found alternative element: ${alternativeElement.id}`);
                }
            }
        }
        
        // ‚ö†Ô∏è FIX 4: Only ONE Supabase Configuration
        // Moved to inside functions to avoid duplicate declaration
        
        // === FIXED: SWIPER INITIALIZATION WITH DESTROY + PROPER SIZING ===
        function initializePropertySwiper(propertyId, images) {
            const mainSwiperElement = document.querySelector(`#main-${propertyId}`);
            const thumbSwiperElement = document.querySelector(`#thumb-${propertyId}`);
            
            if (!mainSwiperElement) {
                console.log(`Main swiper element not found for property ${propertyId}`);
                return null;
            }
            
            // üî• CRITICAL: Destroy existing Swiper instances
            if (mainSwiperElement.swiper) {
                console.log(`Destroying existing Swiper for property ${propertyId}`);
                mainSwiperElement.swiper.destroy(true, true);
            }
            
            if (thumbSwiperElement && thumbSwiperElement.swiper) {
                thumbSwiperElement.swiper.destroy(true, true);
            }
            
            // Initialize thumbnail swiper if needed
            let thumbsSwiper = null;
            if (images.length > 1 && thumbSwiperElement) {
                thumbSwiperElement.style.display = 'block';
                
                thumbsSwiper = new Swiper(thumbSwiperElement, {
                    spaceBetween: 8,
                    slidesPerView: Math.min(4, images.length),
                    freeMode: true,
                    watchSlidesProgress: true,
                    breakpoints: {
                        320: { slidesPerView: Math.min(3, images.length) },
                        768: { slidesPerView: Math.min(4, images.length) }
                    }
                });
            } else if (thumbSwiperElement) {
                thumbSwiperElement.style.display = 'none';
            }
            
            // Initialize main swiper with proper settings
            const mainSwiper = new Swiper(mainSwiperElement, {
                spaceBetween: 0,
                loop: images.length > 1,
                pagination: {
                    el: mainSwiperElement.querySelector('.swiper-pagination'),
                    clickable: true,
                    dynamicBullets: true
                },
                navigation: false,
                thumbs: thumbsSwiper ? { swiper: thumbsSwiper } : undefined,
                autoplay: images.length > 1 ? {
                    delay: 3000,
                    disableOnInteraction: false,
                } : false,
                effect: 'slide',
                speed: 500,
                preloadImages: false,
                lazy: {
                    loadPrevNext: true,
                },
                on: {
                    init: function() {
                        console.log(`‚úÖ Swiper initialized for property ${propertyId} with ${images.length} images`);
                        // Force update after init
                        this.update();
                    },
                    error: function(error) {
                        console.error(`‚ùå Swiper error for property ${propertyId}:`, error);
                    }
                }
            });
            
            return mainSwiper;
        }
        
        // === DEBUG FUNCTION ===
        function debugSwipers() {
            console.log('=== SWIPER DEBUG ===');
            const swipers = document.querySelectorAll('.swiper');
            console.log(`Total Swiper elements: ${swipers.length}`);
            
            swipers.forEach((el, i) => {
                const hasSwiper = el.swiper ? '‚úÖ ACTIVE' : '‚ùå NO INSTANCE';
                const slideCount = el.querySelectorAll('.swiper-slide').length;
                const duplicateCount = el.querySelectorAll('.swiper-slide-duplicate').length;
                console.log(`Swiper ${i}: ${hasSwiper}, Slides: ${slideCount}, Duplicates: ${duplicateCount}`);
            });
        }
        
        // === PART 2: AMENITIES RENDERING + TRUNCATION FUNCTIONS ===
        function renderAmenities(propertyId, description, expanded = false) {
            const container = document.getElementById(`desc-${propertyId}`);
            const toggleBtn = document.getElementById(`toggle-${propertyId}`);

            if (!container || !description) return;

            // Split by newline and filter out empty lines
            const amenities = description.split('\n').filter(line => line.trim().length > 0);
            const visible = expanded ? amenities : amenities.slice(0, 4);

            container.innerHTML = visible.map(amenity => `<li>${amenity.trim()}</li>`).join('');

            if (amenities.length > 4) {
                toggleBtn.style.display = 'inline-block';
                toggleBtn.textContent = expanded
                    ? 'View Less'
                    : `+ ${amenities.length - 4} more amenities`;
            } else {
                toggleBtn.style.display = 'none';
            }
        }

        function toggleAmenities(propertyId) {
            const container = document.getElementById(`desc-${propertyId}`);
            const isExpanded = container.classList.toggle('expanded');
            
            // Get the full description from data attribute
            const fullDescription = container.dataset.full || '';
            
            renderAmenities(
                propertyId,
                fullDescription,
                isExpanded
            );
        }
        
        // UPDATED: Improved search with exact phrase matching and plural/singular handling
        function normalizeSearch(q) {
            if (!q) return '';
            
            // Convert to lowercase
            let normalized = q.toLowerCase();
            
            // Handle bedroom plural/singular variations
            normalized = normalized
                .replace(/bedrooms?/gi, "bedroom")
                .replace(/1\s*bedroom/gi, "1br")
                .replace(/2\s*bedrooms?/gi, "2br")
                .replace(/3\s*bedrooms?/gi, "3br")
                .replace(/4\s*bedrooms?/gi, "4br")
                .replace(/5\s*bedrooms?/gi, "5br")
                .replace(/one\s*bedroom/gi, "1br")
                .replace(/two\s*bedrooms?/gi, "2br")
                .replace(/three\s*bedrooms?/gi, "3br")
                .replace(/four\s*bedrooms?/gi, "4br")
                .replace(/five\s*bedrooms?/gi, "5br");
            
            return normalized;
        }
        
        // UPDATED: Multi-keyword search function with exact phrase matching
        function buildSearchQuery(keyword, supabase) {
            const normalizedKeyword = normalizeSearch(keyword);
            const keywords = normalizedKeyword.split(' ').filter(k => k.length > 0);
            
            let query = supabase
                .from("properties")
                .select("*")
                .eq("is_active", true);
            
            if (keywords.length === 0) return query;
            
            // Build OR conditions for each keyword
            let conditions = [];
            keywords.forEach(word => {
                if (word.length > 0) {
                    // Search in multiple fields
                    conditions.push(`title.ilike.%${word}%`);
                    conditions.push(`description.ilike.%${word}%`);
                    conditions.push(`location.ilike.%${word}%`);
                    conditions.push(`unit_type.ilike.%${word}%`);
                    
                    // Also search for the original word (without normalization) for better matching
                    conditions.push(`title.ilike.%${word.replace(/br$/, ' bedroom')}%`);
                    conditions.push(`description.ilike.%${word.replace(/br$/, ' bedroom')}%`);
                }
            });
            
            // Also add exact phrase search
            conditions.push(`title.ilike.%${normalizedKeyword}%`);
            conditions.push(`description.ilike.%${normalizedKeyword}%`);
            
            if (conditions.length > 0) {
                query = query.or(conditions.join(','));
            }
            
            return query;
        }
        
        // PHASE 5 ‚Äî Season Pricing Logic
        function isPeakSeason(date) {
            if (!date) {
                date = new Date();
            }
            const m = date.getMonth() + 1;
            const d = date.getDate();
            
            // Peak season logic:
            // 1. Jan 1-10
            // 2. July, August, November, December
            if (m === 1 && d <= 10) return true;
            if ([7, 8, 11, 12].includes(m)) return true;
            return false;
        }
        
        // Calculate display price with commission
        function calculateDisplayPrice(property, checkinDate = null) {
            if (!property) return 'N/A';
            
            // Use provided checkin date or current date
            const date = checkinDate || new Date();
            
            // Determine base price based on season
            const basePrice = isPeakSeason(date) 
                ? (property.peak_price || 0) 
                : (property.low_price || 0);
            
            // Apply 20% commission
            const finalPrice = Math.round(basePrice * 1.2);
            
            // Format price with commas
            return finalPrice.toLocaleString('en-KE', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
        
        // UPDATED: Unit type labels for display - ADDED VILLA
        const unitTypeLabels = {
            studio: "Studio",
            "1br": "1 Bedroom",
            "2br": "2 Bedrooms",
            "3br": "3 Bedrooms",
            "4br": "4 Bedrooms",
            "5br": "5 Bedrooms",
            "villa": "Villa"
        };
        
        // UPDATED: Create property card function with proper Swiper class names and short UUID
        function createPropertyCard(property) {
            const card = document.createElement('div');
            card.className = 'property-card';
            // UPDATE: Use shortUUID for the id - THIS IS CRITICAL
            const shortId = shortUUID(property.id);
            card.id = `property-${shortId}`;
            
            // Calculate price
            const displayPrice = calculateDisplayPrice(property, selectedCheckin);
            
            // Get property type display
            const propertyTypeDisplay = unitTypeLabels[property.unit_type] || property.unit_type || 'Property';
            
            // FIXED: Show beds from property.beds instead of bedrooms
            const bedsCount = property.beds || 1;
            const bedsDisplay = `${bedsCount} ${bedsCount === 1 ? 'Bed' : 'Beds'}`;
            
            // Escape special characters for safety
            const safeTitle = property.title ? property.title.replace(/'/g, "\\'") : 'Property';
            
            card.innerHTML = `
                <div class="property-gallery">
                    <div class="swiper mainSwiper" id="main-${property.id}">
                        <div class="swiper-wrapper">
                            <!-- Images will be loaded here -->
                            <div class="swiper-slide">
                                <img src="https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" 
                                     alt="${property.title || 'Property'} placeholder image"
                                     onerror="this.src='https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
                            </div>
                        </div>
                        <div class="swiper-pagination"></div>
                    </div>
                    <div class="swiper thumbSwiper" id="thumb-${property.id}" style="display: none;">
                        <div class="swiper-wrapper"></div>
                    </div>
                </div>
                
                <div class="property-content">
                    <h3 class="property-title">${property.title || 'Premium Property'}</h3>
                    <div class="property-meta">
                        <span class="property-location">
                            <i class="fas fa-map-marker-alt"></i> ${property.location || 'Coastal Kenya'}
                        </span>
                        <span class="property-type">${propertyTypeDisplay}</span>
                    </div>
                    
                    <!-- === PART 2: AMENITIES AS POINTS === -->
                    <ul class="property-desc" id="desc-${property.id}" data-full="${property.description || ''}">
                    </ul>
                    <button class="view-more-btn" id="toggle-${property.id}" onclick="toggleAmenities('${property.id}')" style="display: none;">
                    </button>
                    
                    <div class="property-price">Ksh ${displayPrice} <span style="font-size: 0.9rem; color: var(--gray);">/ night</span></div>
                    
                    <!-- FIXED: Updated footer with beds information and removed internal_code -->
                    <div class="property-footer">
                        <div class="property-info">
                            <div class="property-beds">
                                <i class="fas fa-bed"></i> ${bedsDisplay}
                            </div>
                        </div>
                        <button class="btn-primary" onclick="checkAvailability('${property.id}', '${safeTitle}')">
                            <i class="fas fa-calendar-alt"></i> Check Availability
                        </button>
                    </div>
                </div>
            `;
            
            // Render amenities after card is created
            setTimeout(() => {
                renderAmenities(property.id, property.description, false);
            }, 0);
            
            return card;
        }
        
        // FIXED: Load Property Images Function with proper Swiper initialization
        async function loadPropertyImages(property) {
            // Wait a bit to ensure DOM is ready
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Check if the card exists in DOM - using short UUID
            const shortId = shortUUID(property.id);
            const card = document.querySelector(`#property-${shortId}`);
            if (!card) {
                console.log(`Card for property ${property.id} (short: ${shortId}) not found in DOM, skipping image load.`);
                return;
            }
            
            const mainWrapper = card.querySelector(`#main-${property.id} .swiper-wrapper`);
            if (!mainWrapper) {
                console.log(`Main wrapper not found for property ${property.id}`);
                return;
            }
            
            let images = [];
            
            // Try to load from Supabase storage first
            try {
                console.log(`Loading images for property: ${property.id}`);
                
                // Create Supabase client inside function
                const SUPABASE_URL = "https://aanyrtsfeeynykskwxen.supabase.co";
                const SUPABASE_KEY = "sb_publishable_jda30uQX9ZzR_V8CzkeERw_nfx-QWkD";
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // List all files in the property's folder
                const { data: files, error } = await supabase
                    .storage
                    .from('property_images')
                    .list(property.id);
                
                if (error) {
                    console.log(`Error listing files for ${property.id}:`, error.message);
                } else if (files && files.length > 0) {
                    // Sort files by name (01.jpeg, 02.jpeg, etc.)
                    files.sort((a, b) => {
                        // Extract numbers from filenames for sorting
                        const numA = parseInt(a.name.match(/\d+/)?.[0]) || 0;
                        const numB = parseInt(b.name.match(/\d+/)?.[0]) || 0;
                        return numA - numB;
                    });
                    
                    // Get public URLs for each file
                    files.forEach(file => {
                        const { data } = supabase
                            .storage
                            .from('property_images')
                            .getPublicUrl(`${property.id}/${file.name}`);
                        
                        if (data && data.publicUrl) {
                            images.push(data.publicUrl);
                        }
                    });
                }
            } catch (error) {
                console.log(`Error loading storage images for property ${property.id}:`, error);
            }
            
            // If no images found in storage, use the primary image or placeholder
            if (images.length === 0) {
                if (property.image_url) {
                    images.push(property.image_url);
                } else {
                    images.push('https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');
                }
            }
            
            // Clear existing content
            mainWrapper.innerHTML = '';
            
            const thumbWrapper = card.querySelector(`#thumb-${property.id} .swiper-wrapper`);
            if (thumbWrapper) thumbWrapper.innerHTML = '';
            
            // Render slides
            images.forEach((url, index) => {
                mainWrapper.innerHTML += `
                    <div class="swiper-slide">
                        <img src="${url}" alt="${property.title || 'Property'} image ${index + 1}" 
                             onerror="this.src='https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
                    </div>
                `;
                
                if (thumbWrapper && images.length > 1) {
                    thumbWrapper.innerHTML += `
                        <div class="swiper-slide">
                            <img src="${url}" alt="${property.title || 'Property'} thumbnail ${index + 1}"
                                 onerror="this.src='https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'">
                        </div>
                    `;
                }
            });
            
            // üî• CRITICAL: Initialize Swiper with destroy fix and proper sizing
            setTimeout(() => {
                initializePropertySwiper(property.id, images);
            }, 200);
        }
        
        // Calendar functionality
        function initCalendarDates() {
            // Initialize with NO dates selected - user must choose
            selectedCheckin = null;
            selectedCheckout = null;
            
            updateDateRangeInput();
        }

        function updateDateRangeInput() {
            const dateRangeInput = document.getElementById('dateRange');
            if (dateRangeInput) {
                if (selectedCheckin && selectedCheckout) {
                    dateRangeInput.value = `${formatDate(selectedCheckin)} ‚Üí ${formatDate(selectedCheckout)}`;
                } else if (selectedCheckin) {
                    dateRangeInput.value = `${formatDate(selectedCheckin)} ‚Üí Select checkout`;
                } else {
                    dateRangeInput.value = 'Select check-in ‚Üí Select check-out';
                }
            }
        }

        function generateCalendar() {
            const calendar = document.getElementById('calendarContainer');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = `
                <div class="calendar-header">
                    <h4>Select Check-in & Check-out Dates</h4>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)" aria-label="Previous month">‚Äπ</button>
                        <h4>${getMonthName(currentMonth)} ${currentYear}</h4>
                        <button onclick="changeMonth(1)" aria-label="Next month">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
            `;

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Empty cells before month starts
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="calendar-day disabled"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                date.setHours(0, 0, 0, 0);

                const isToday = isSameDay(date, today);
                const isCheckin = selectedCheckin && isSameDay(date, selectedCheckin);
                const isCheckout = selectedCheckout && isSameDay(date, selectedCheckout);
                const isDisabled = date < today;
                const isBetween =
                    selectedCheckin &&
                    selectedCheckout &&
                    date > selectedCheckin &&
                    date < selectedCheckout;

                let className = "calendar-day";
                if (isToday) className += " today";
                if (isCheckin) className += " selected";
                if (isCheckout) className += " selected";
                if (isDisabled) className += " disabled";
                if (isBetween) className += " between";

                const onClick = isDisabled
                    ? ""
                    : `onclick="selectDate(${day}, ${currentMonth}, ${currentYear})"`;

                html += `<div class="${className}" ${onClick}>${day}</div>`;
            }

            // Fill up to 6 rows (42 cells) to keep calendar compact
            const totalCells = firstDay + daysInMonth;
            const remaining = 42 - totalCells;

            for (let i = 0; i < remaining; i++) {
                html += `<div class="calendar-day disabled"></div>`;
            }

            html += `
                </div>
                <div class="selected-dates-display">
                    <div>
                        <strong>Check-in</strong><br>
                        ${selectedCheckin ? formatDate(selectedCheckin) : "Not selected"}
                    </div>
                    <div>
                        <strong>Check-out</strong><br>
                        ${selectedCheckout ? formatDate(selectedCheckout) : "Not selected"}
                    </div>
                </div>
                <div class="calendar-actions">
                    <button class="calendar-clear" onclick="clearDates()">Clear Dates</button>
                    <button class="calendar-apply" onclick="applyDates()">Apply Dates</button>
                </div>
            `;

            calendar.innerHTML = html;
        }

        function selectDate(day, month, year) {
            const date = new Date(year, month, day);
            date.setHours(0, 0, 0, 0);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (date < today) return;

            if (!selectedCheckin) {
                // First click: set as check-in
                selectedCheckin = date;
                selectedCheckout = null;
            } else if (!selectedCheckout && date > selectedCheckin) {
                // Second click with valid date: set as check-out
                selectedCheckout = date;
            } else if (isSameDay(date, selectedCheckin)) {
                // Clicking on check-in again: clear both
                selectedCheckin = null;
                selectedCheckout = null;
            } else if (date < selectedCheckin) {
                // Clicking earlier date: set as new check-in
                selectedCheckin = date;
                selectedCheckout = null;
            } else if (selectedCheckin && !selectedCheckout && date <= selectedCheckin) {
                // Clicking same or earlier date when only check-in is set: set as new check-in
                selectedCheckin = date;
                selectedCheckout = null;
            } else {
                // Otherwise: set as check-out
                selectedCheckout = date;
            }

            updateDateRangeInput();
            generateCalendar();
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            } else if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar();
        }

        function clearDates() {
            selectedCheckin = null;
            selectedCheckout = null;
            
            updateDateRangeInput();
            generateCalendar();
        }

        function applyDates() {
            if (!selectedCheckin || !selectedCheckout) {
                alert("Please select both check-in and check-out dates");
                return;
            }
            
            if (selectedCheckin >= selectedCheckout) {
                alert("Check-out date must be after check-in date");
                return;
            }
            
            hideCalendar();
        }

        function isSameDay(date1, date2) {
            if (!date1 || !date2) return false;
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function getMonthName(month) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            return months[month];
        }

        function formatDate(date) {
            if (!date) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // FIXED: Header search functionality with multi-keyword support
        async function searchPropertiesWithKeyword(keyword) {
            // Show search results section
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('stays').style.display = 'none';
            
            // Scroll to results
            document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
            
            // Update results header
            const resultsHeader = document.getElementById('resultsHeader');
            const searchCriteria = document.getElementById('searchCriteria');
            const datesCriteria = document.getElementById('datesCriteria');
            
            searchCriteria.textContent = `Search results for: "${keyword}"`;
            datesCriteria.textContent = (selectedCheckin && selectedCheckout) 
                ? `Dates: ${formatDate(selectedCheckin)} to ${formatDate(selectedCheckout)}`
                : 'Flexible dates';
            
            resultsHeader.style.display = 'block';
            
            // Load filtered properties with keyword
            await loadFilteredPropertiesWithKeyword(keyword);
        }
        
        // FIXED: Load filtered properties with multi-keyword search and proper DOM rendering
        async function loadFilteredPropertiesWithKeyword(keyword) {
            const container = document.getElementById('propertyList');
            container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Searching properties...</div>';
            
            try {
                // Create Supabase client inside function
                const SUPABASE_URL = "https://aanyrtsfeeynykskwxen.supabase.co";
                const SUPABASE_KEY = "sb_publishable_jda30uQX9ZzR_V8CzkeERw_nfx-QWkD";
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Build query with multiple keyword support
                let query = buildSearchQuery(keyword, supabase);
                
                query = query.order('created_at', { ascending: false });
                
                const { data, error } = await query;
                
                if (error) {
                    console.error("Search error:", error);
                    container.innerHTML = '<div class="no-properties"><i class="fas fa-exclamation-triangle"></i><p>Error searching properties. Please try again.</p></div>';
                    return;
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-properties"><i class="fas fa-search"></i><p>No properties found matching your search.</p><p>Try different keywords or browse all properties.</p></div>';
                    return;
                }
                
                // Update results count
                document.getElementById('resultsCount').textContent = `Found ${data.length} propert${data.length === 1 ? 'y' : 'ies'} for "${keyword}"`;
                
                // FIXED: Clear container by removing child elements instead of innerHTML
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                
                // FIXED: Create document fragment for batch append
                const fragment = document.createDocumentFragment();
                const cards = [];
                
                // First create all cards and append to fragment
                data.forEach(property => {
                    const card = createPropertyCard(property);
                    cards.push({ property, card });
                    fragment.appendChild(card);
                });
                
                // Append all cards at once
                container.appendChild(fragment);
                
                // THEN load images for each property after DOM is ready
                setTimeout(() => {
                    cards.forEach(({ property }) => {
                        loadPropertyImages(property);
                    });
                    // Debug after loading
                    setTimeout(debugSwipers, 500);
                }, 300);
                
            } catch (error) {
                console.error("Error:", error);
                container.innerHTML = '<div class="no-properties"><i class="fas fa-exclamation-triangle"></i><p>Unable to search properties. Please check your connection.</p></div>';
            }
        }
        
        // PHASE 4 ‚Äî Search Properties Function (UPDATED - no keywords parameter)
        async function searchProperties() {
            const location = document.getElementById('searchLocation').value;
            const propertyType = document.getElementById('propertyType').value;
            
            // Show search results section
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('stays').style.display = 'none';
            
            // Scroll to results
            document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
            
            // Update results header
            const resultsHeader = document.getElementById('resultsHeader');
            const searchCriteria = document.getElementById('searchCriteria');
            const datesCriteria = document.getElementById('datesCriteria');
            
            let criteriaText = [];
            if (location) criteriaText.push(location);
            if (propertyType) {
                criteriaText.push(unitTypeLabels[propertyType] || propertyType);
            }
            
            searchCriteria.textContent = criteriaText.length > 0 
                ? `Properties in ${criteriaText.join(' ‚Ä¢ ')}`
                : 'All Properties';
            
            datesCriteria.textContent = (selectedCheckin && selectedCheckout) 
                ? `Dates: ${formatDate(selectedCheckin)} to ${formatDate(selectedCheckout)}`
                : 'Flexible dates';
            
            resultsHeader.style.display = 'block';
            
            // Load filtered properties (without keywords parameter)
            await loadFilteredProperties(location, propertyType);
        }
        
        // FIXED: Load filtered properties without keyword search with proper DOM rendering
        async function loadFilteredProperties(location, propertyType) {
            const container = document.getElementById('propertyList');
            container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Searching properties...</div>';
            
            try {
                // Create Supabase client inside function
                const SUPABASE_URL = "https://aanyrtsfeeynykskwxen.supabase.co";
                const SUPABASE_KEY = "sb_publishable_jda30uQX9ZzR_V8CzkeERw_nfx-QWkD";
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                let query = supabase
                    .from("properties")
                    .select("*")
                    .eq("is_active", true);
                
                // Apply location filter
                if (location && location !== '') {
                    query = query.eq('location', location);
                }
                
                // Apply property type filter
                if (propertyType && propertyType !== '') {
                    query = query.eq('unit_type', propertyType);
                }
                
                query = query.order('created_at', { ascending: false });
                
                const { data, error } = await query;
                
                if (error) {
                    console.error("Search error:", error);
                    container.innerHTML = '<div class="no-properties"><i class="fas fa-exclamation-triangle"></i><p>Error searching properties. Please try again.</p></div>';
                    return;
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-properties"><i class="fas fa-search"></i><p>No properties found matching your search.</p><p>Try different filters or browse all properties.</p></div>';
                    return;
                }
                
                // Update results count
                document.getElementById('resultsCount').textContent = `Found ${data.length} propert${data.length === 1 ? 'y' : 'ies'}`;
                
                // FIXED: Clear container by removing child elements instead of innerHTML
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                
                // FIXED: Create document fragment for batch append
                const fragment = document.createDocumentFragment();
                const cards = [];
                
                // First create all cards and append to fragment
                data.forEach(property => {
                    const card = createPropertyCard(property);
                    cards.push({ property, card });
                    fragment.appendChild(card);
                });
                
                // Append all cards at once
                container.appendChild(fragment);
                
                // THEN load images for each property after DOM is ready
                setTimeout(() => {
                    cards.forEach(({ property }) => {
                        loadPropertyImages(property);
                    });
                    // Debug after loading
                    setTimeout(debugSwipers, 500);
                }, 300);
                
            } catch (error) {
                console.error("Error:", error);
                container.innerHTML = '<div class="no-properties"><i class="fas fa-exclamation-triangle"></i><p>Unable to search properties. Please check your connection.</p></div>';
            }
        }
        
        // ORIGINAL: Load all properties with proper DOM rendering
        async function loadAllProperties() {
            const container = document.getElementById('propertyList');
            container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading all properties...</div>';
            
            try {
                // Create Supabase client inside function
                const SUPABASE_URL = "https://aanyrtsfeeynykskwxen.supabase.co";
                const SUPABASE_KEY = "sb_publishable_jda30uQX9ZzR_V8CzkeERw_nfx-QWkD";
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                const { data, error } = await supabase
                    .from("properties")
                    .select("*")
                    .eq("is_active", true)
                    .order("created_at", { ascending: false });
                
                if (error) {
                    console.error("Error loading properties:", error);
                    container.innerHTML = '<div class="no-properties"><p>Unable to load properties. Please try again later.</p></div>';
                    return;
                }
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-properties"><p>No properties available at the moment. Check back soon!</p></div>';
                    return;
                }
                
                // FIXED: Clear container by removing child elements instead of innerHTML
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
                
                // FIXED: Create document fragment for batch append
                const fragment = document.createDocumentFragment();
                const cards = [];
                
                // First create all cards and append to fragment
                data.forEach(property => {
                    const card = createPropertyCard(property);
                    cards.push({ property, card });
                    fragment.appendChild(card);
                });
                
                // Append all cards at once
                container.appendChild(fragment);
                
                // THEN load images for each property after DOM is ready
                setTimeout(() => {
                    cards.forEach(({ property }) => {
                        loadPropertyImages(property);
                    });
                    // Debug after loading
                    setTimeout(debugSwipers, 500);
                }, 300);
                
            } catch (error) {
                console.error("Error:", error);
                container.innerHTML = '<div class="no-properties"><p>Error loading properties. Please refresh the page.</p></div>';
            }
        }
        
        // FIXED: Load featured properties with proper DOM rendering
        async function loadFeaturedProperties() {
            const container = document.getElementById('featuredProperties');
            
            try {
                // Create Supabase client inside function
                const SUPABASE_URL = "https://aanyrtsfeeynykskwxen.supabase.co";
                const SUPABASE_KEY = "sb_publishable_jda30uQX9ZzR_V8CzkeERw_nfx-QWkD";
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // First try to get featured properties
                let query = supabase
                    .from("properties")
                    .select("*")
                    .eq("is_active", true)
                    .eq("is_featured", true)
                    .order("created_at", { ascending: false })
                    .limit(6);
                
                const { data, error } = await query;
                
                if (error || !data || data.length === 0) {
                    // If no featured properties, get recent ones
                    query = supabase
                        .from("properties")
                        .select("*")
                        .eq("is_active", true)
                        .order("created_at", { ascending: false })
                        .limit(6);
                    
                    const { data: recentData, error: recentError } = await query;
                    
                    if (recentError || !recentData || recentData.length === 0) {
                        container.innerHTML = '<div class="no-properties">No featured properties at the moment.</div>';
                        return;
                    }
                    
                    displayProperties(recentData, container);
                    return;
                }
                
                displayProperties(data, container);
                
            } catch (error) {
                console.error("Error:", error);
                container.innerHTML = '<div class="no-properties">Unable to load featured properties.</div>';
            }
        }
        
        // FIXED: Display properties with proper DOM rendering (no innerHTML overwrites)
        function displayProperties(properties, container) {
            // FIXED: Clear container by removing child elements instead of innerHTML
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            // FIXED: Create document fragment for batch append
            const fragment = document.createDocumentFragment();
            const cards = [];
            
            // First create all cards and append to fragment
            properties.forEach(property => {
                const card = createPropertyCard(property);
                cards.push({ property, card });
                fragment.appendChild(card);
            });
            
            // Append all cards at once
            container.appendChild(fragment);
            
            // THEN load images for each property after DOM is ready
            setTimeout(() => {
                cards.forEach(({ property }) => {
                    loadPropertyImages(property);
                });
                // Debug after loading
                setTimeout(debugSwipers, 500);
            }, 300);
        }
        
        // UPDATED: WhatsApp Message Function with short UUID anchor link
        function openWhatsApp(property, checkin, checkout, rate) {
            const anchorId = shortUUID(property.id);
            const propertyLink = `https://pwanistays.com/#property-${anchorId}`;

            const message = `
Property: ${property.title}
Link: ${propertyLink}
Dates: ${checkin} ‚Üí ${checkout}
Rate: KES ${rate}/night

Hello PwaniStays! I am interested in this property. Is it available for the selected dates?
`.trim();

            const whatsappNumber = "254738544784";
            const encodedMessage = encodeURIComponent(message);

            window.open(
                `https://wa.me/${whatsappNumber}?text=${encodedMessage}`,
                "_blank"
            );
        }
        
        // UPDATED: Check Availability function that uses openWhatsApp
        function checkAvailability(propertyId, propertyTitle) {
            // Get property element - try both with full ID and short UUID
            let propertyElement = document.getElementById(`property-${propertyId}`);
            if (!propertyElement) {
                // Try with short UUID
                const shortId = shortUUID(propertyId);
                propertyElement = document.getElementById(`property-${shortId}`);
                if (!propertyElement) {
                    console.log(`Could not find property element for ID: ${propertyId}`);
                    return;
                }
            }
            
            // Get price
            const priceElement = propertyElement.querySelector('.property-price');
            const price = priceElement ? priceElement.textContent.replace('Ksh ', '').replace(' / night', '') : 'Price on request';
            
            // Get dates
            const checkinDate = selectedCheckin ? formatDate(selectedCheckin) : 'Not selected';
            const checkoutDate = selectedCheckout ? formatDate(selectedCheckout) : 'Not selected';
            
            // Create property object with needed data
            const property = {
                id: propertyId,
                title: propertyTitle
            };
            
            // Call the new openWhatsApp function
            openWhatsApp(property, checkinDate, checkoutDate, price);
        }
        
        function showAllProperties() {
            // Show search results section
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('stays').style.display = 'none';
            
            // Clear any filters
            document.getElementById('searchLocation').value = '';
            document.getElementById('propertyType').value = '';
            updateDateRangeInput();
            
            // Update results header
            const resultsHeader = document.getElementById('resultsHeader');
            const searchCriteria = document.getElementById('searchCriteria');
            const datesCriteria = document.getElementById('datesCriteria');
            
            searchCriteria.textContent = 'All Properties';
            datesCriteria.textContent = '';
            resultsHeader.style.display = 'none';
            
            // Scroll to results
            document.getElementById('searchResults').scrollIntoView({ behavior: 'smooth' });
            
            // Load all properties
            loadAllProperties();
        }
        
        function filterByLocation(location) {
            document.getElementById('searchLocation').value = location;
            searchProperties();
        }
        
        function clearSearch() {
            // Reset filters
            document.getElementById('searchLocation').value = '';
            document.getElementById('propertyType').value = '';
            updateDateRangeInput();
            
            // Show featured properties section
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('stays').style.display = 'block';
            
            // Scroll to featured properties
            document.getElementById('stays').scrollIntoView({ behavior: 'smooth' });
            
            // Reload featured properties
            loadFeaturedProperties();
        }
        
        // Testimonials functionality
        let currentTestimonial = 0;
        const totalTestimonials = 12;
        
        function initTestimonials() {
            const dotsContainer = document.querySelector('.testimonial-dots');
            if (!dotsContainer) return;
            
            // Create dots
            for (let i = 0; i < totalTestimonials; i++) {
                const dot = document.createElement('button');
                dot.className = `testimonial-dot ${i === 0 ? 'active' : ''}`;
                dot.setAttribute('aria-label', `View testimonial ${i + 1}`);
                dot.addEventListener('click', () => showTestimonial(i));
                dotsContainer.appendChild(dot);
            }
            
            // Navigation buttons
            const prevBtn = document.querySelector('.testimonial-prev');
            const nextBtn = document.querySelector('.testimonial-next');
            
            if (prevBtn) prevBtn.addEventListener('click', prevTestimonial);
            if (nextBtn) nextBtn.addEventListener('click', nextTestimonial);
            
            // Auto-rotate
            setInterval(nextTestimonial, 5000);
        }
        
        function showTestimonial(index) {
            const slides = document.querySelectorAll('.testimonial-slide');
            const dots = document.querySelectorAll('.testimonial-dot');
            
            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));
            
            if (slides[index]) slides[index].classList.add('active');
            if (dots[index]) dots[index].classList.add('active');
            currentTestimonial = index;
        }
        
        function nextTestimonial() {
            currentTestimonial = (currentTestimonial + 1) % totalTestimonials;
            showTestimonial(currentTestimonial);
        }
        
        function prevTestimonial() {
            currentTestimonial = (currentTestimonial - 1 + totalTestimonials) % totalTestimonials;
            showTestimonial(currentTestimonial);
        }
        
        // Star Rating functionality
        let selectedRating = 0;
        
        function initStarRating() {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    setRating(rating);
                });
                
                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    highlightStars(rating);
                });
            });
            
            // Reset stars when mouse leaves rating container
            document.querySelector('.star-rating').addEventListener('mouseleave', function() {
                highlightStars(selectedRating);
            });
        }
        
        function setRating(rating) {
            selectedRating = rating;
            highlightStars(rating);
            
            // Update rating text
            const ratingText = document.getElementById('ratingText');
            const ratingMessages = [
                "Click to rate your experience",
                "Poor - We'll do better",
                "Fair - Room for improvement",
                "Good - Satisfied with our service",
                "Very Good - Had a great experience",
                "Excellent - Absolutely loved it!"
            ];
            ratingText.textContent = ratingMessages[rating];
        }
        
        function highlightStars(rating) {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.add('selected');
                } else {
                    star.classList.remove('selected');
                }
            });
        }
        
        // Submit feedback
        function submitFeedback() {
            const name = document.getElementById('feedbackName').value.trim();
            const city = document.getElementById('feedbackCity').value.trim();
            const country = document.getElementById('feedbackCountry').value.trim();
            const comment = document.getElementById('feedbackComment').value.trim();
            
            // Validation
            if (!name) {
                showFeedbackMessage('Please enter your name', 'error');
                return;
            }
            
            if (selectedRating === 0) {
                showFeedbackMessage('Please select a rating', 'error');
                return;
            }
            
            if (!comment) {
                showFeedbackMessage('Please enter your review', 'error');
                return;
            }
            
            // Disable submit button
            const submitBtn = document.getElementById('submitFeedbackBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            // Simulate submission (in real app, you would send to your backend)
            setTimeout(() => {
                // Show success message
                showFeedbackMessage('Thank you for your feedback! Your review has been submitted successfully.', 'success');
                
                // Reset form
                document.getElementById('feedbackName').value = '';
                document.getElementById('feedbackCity').value = '';
                document.getElementById('feedbackCountry').value = '';
                document.getElementById('feedbackComment').value = '';
                setRating(0);
                
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Submit Your Review';
                
            }, 1500);
        }
        
        function showFeedbackMessage(message, type) {
            const messageDiv = document.getElementById('feedbackMessage');
            messageDiv.textContent = message;
            messageDiv.style.color = type === 'error' ? '#dc3545' : '#28a745';
            messageDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }
        
        // Form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                service: document.getElementById('service').value,
                message: document.getElementById('message').value.trim()
            };
            
            if (!formData.name || !formData.email || !formData.phone || !formData.service || !formData.message) {
                alert('Please fill all required fields marked with *');
                return;
            }
            
            alert(`Thank you ${formData.name}! Our coastal experts will contact you within 30 minutes.`);
            e.target.reset();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // UPDATED: Smooth scrolling for all anchor links
        document.addEventListener('click', function(e) {
            if (e.target.matches('a[href^="#"]')) {
                e.preventDefault();
                const href = e.target.getAttribute('href');
                if (href.startsWith('#property-')) {
                    const shortId = href.replace('#property-', '');
                    // Show search results and load properties
                    document.getElementById('searchResults').style.display = 'block';
                    document.getElementById('stays').style.display = 'none';
                    loadAllPropertiesAndScroll(shortId);
                } else {
                    // Regular anchor link (like #home, #stays, etc.)
                    const targetId = href.substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 80,
                            behavior: 'smooth'
                        });
                    }
                }
            }
        });
    </script>
</body>
</html>